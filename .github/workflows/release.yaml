name: Mirror Clean Release
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-sync:
    runs-on: windows-latest
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          path: main_source

      # 1. BUILD FRONTEND
      - name: Build UI
        run: |
          cd main_source/frontend
          npm install
          npm run build

      # 2. COMPILE LAUNCHER
      - name: Compile LoomLauncher
        run: g++ main_source/LoomLauncher.cpp -o main_source/LoomLauncher.exe -mwindows -s

      # 3. CONSTRUCT THE CLEAN MIRROR
      - name: Prepare Clean Folder
        shell: bash
        run: |
          # 1. Copy everything to maintain exact structure
          mkdir -p clean_dist
          cp -r main_source/. clean_dist/
          cd clean_dist

          # 2. DELETE ONLY THE JUNK (No renaming)
          rm -rf .git .github .gitignore .vscode
          rm -f LoomLauncher.cpp
          
          # 3. CLEAN FRONTEND (Keep only the 'dist' folder inside 'frontend')
          # This keeps the path as: frontend/dist/
          find frontend -mindepth 1 -maxdepth 1 ! -name 'dist' -exec rm -rf {} +

          # 4. Clean up Python leftovers in any directory
          find . -type d -name "__pycache__" -exec rm -rf {} +
          find . -type d -name "node_modules" -exec rm -rf {} +

          echo "Final folder structure (Strictly following original naming):"
          ls -R

      # 4. FORCE PUSH TO RELEASE BRANCH
      - name: Sync to Release Branch
        shell: bash
        run: |
          cd clean_dist
          git init
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b release
          git add .
          git commit -m "Mirroring stable release from main: ${GITHUB_SHA}"
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git push origin release --force