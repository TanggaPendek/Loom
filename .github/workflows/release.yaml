name: Mirror Clean Release
on:
  push:
    branches:
      - main  # Trigger only when main (stable) is updated

permissions:
  contents: write

jobs:
  build-and-sync:
    runs-on: windows-latest
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          path: main_source

      # 1. BUILD FRONTEND
      - name: Build UI
        run: |
          cd main_source/frontend
          npm install
          npm run build

      # 2. COMPILE LAUNCHER
      - name: Compile LoomLauncher
        run: g++ main_source/LoomLauncher.cpp -o main_source/LoomLauncher.exe -mwindows -s

      # 3. CONSTRUCT THE CLEAN MIRROR
      - name: Prepare Clean Folder
        shell: pwsh
        run: |
          # Create the root distribution folder
          New-Item -Path "clean_dist" -ItemType Directory -Force
          
          # FILES: Copy root files
          Copy-Item "main_source/LoomLauncher.exe" "clean_dist/"
          Copy-Item "main_source/Launcher.py" "clean_dist/"
          Copy-Item "main_source/requirements.txt" "clean_dist/"
          Copy-Item "main_source/README.md" "clean_dist/"

          # FOLDERS: Copy specific folders (using Recurse for directories)
          Copy-Item -Path "main_source/backend/src" -Destination "clean_dist/backend" -Recurse -Force
          Copy-Item -Path "main_source/executor" -Destination "clean_dist/" -Recurse -Force
          Copy-Item -Path "main_source/frontend/dist" -Destination "clean_dist/ui" -Recurse -Force
          Copy-Item -Path "main_source/nodebank" -Destination "clean_dist/" -Recurse -Force
          Copy-Item -Path "main_source/userdata" -Destination "clean_dist/" -Recurse -Force

      # 4. FORCE PUSH TO RELEASE BRANCH
      - name: Sync to Release Branch
        run: |
          cd clean_dist
          git init
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b release
          git add .
          git commit -m "Mirroring stable release from main: ${{ github.sha }}"
          # This force-pushes to the 'release' branch, overwriting old junk
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin release --force